
https://tryhackme.com/r/room/intromalwareanalysis

#Malware #Subscribers 

in this room, you will learn:
- What is malware?
- How to start analyzing a malware
- Static and Dynamic malware analysis
- Resources to help you analyze malware

## malware analysis 

malicious software 
Malware Analysis is performed by the following people in the Security Industry:

- **Security Operations** teams analyze malware to write detections for malicious activity in their networks.
- **Incident Response** teams analyze malware to determine what damage has been done to an environment to remediate and revert that damage.
- **Threat Hunt** teams analyze malware to identify IOCs, which they use to hunt for malware in a network.
- **Malware Researchers** in security product vendor teams analyze malware to add detections for them in their security products.
- **Threat Research** teams in OS Vendors like Microsoft and Google analyze malware to discover the vulnerabilities exploited and add more security features to the OS/applications.

> Please note that malware is like a weapon because it can produce great harm if not handled with care.

### <span style="color:#a0f958">following precautions while analyzing malware</span>:

- Never analyze malware or suspected malware on a machine that does not have the sole purpose of analyzing malware.
- When not analyzing or moving malware samples around to different locations, always keep them in password-protected zip/rar or other archives so that we can avoid accidental detonation.
- Only extract the malware from this password-protected archive inside the isolated environment, and only when analyzing it.
- Create an isolated VM specifically for malware analysis, which has the capability of being reverted to a clean slate once you are done.
- Ensure that all internet connections are closed or at least monitored.
- Once you are done with malware analysis, revert the VM to its clean slate for the next malware analysis session to avoid residue from a previous malware execution corrupting the next one.


## techniques of malware analysis 

Malware Analysis is like solving a puzzle. Different tools and techniques are used to find the pieces of this puzzle, and joining those pieces gives us the complete picture of what the malware is trying to do. Most of the time, you will have an executable file (also called a binary or a PE file. PE stands for Portable Executable), a malicious document file, or a Network Packet Capture (Pcap). The Portable Executable is the most prevalent type of file analyzed while performing Malware Analysis.

- static analysis = don't execute the code (checking strings for malware)
	- techniques avoid static analysis  = obfuscation , packing, hiding properties 
- dynamic analysis = executes the code for analysis in VM
	- tools monitor the malware activity but often code detects which environment 
	- disassembler convert malware code from binary to assembly  to look at the instructions, allows start and stop malware


## analysis 

step 1 = static analysis, overview  in a VM Remnux VM (rev eng malware linux) 

https://docs.remnux.org/

```
# attackbox
ubuntu : 123456
```

malware with tricky file extensions
```
file <filename>

strings <filename>

md5sum <filename>
sha1sum <filename>
sha256 <filename>

VirusTotal 
```


Remnux VM box
```
cd ~/Desktop/Samples/

md5sum redline
ca2dc5a3f94c4f19334cc8b68f256259

virustotal 
Creation Time 2020-08-01 02:44:18 UTC
```


## PE file handler 

he PE File Header contains the metadata about a Portable Executable file. This data can help us find a lot of helpful information to help us in our analysis.

A PE file seldom contains all the code that it needs to run on a system on its own. Most of the time, it re-uses code provided by the Operating System. This is done to use less space and leverage the framework the Operating System has laid to perform tasks instead of re-inventing the wheel. Imports are such functions that the PE file imports from outside to perform different tasks.

we can always consult [Microsoft Documentation](https://docs.microsoft.com/en-us/windows/win32/api/_winprog/) to verify the purpose of a particular Windows function.

A PE file is divided into different sections which have different purposes. Although the sections in a PE file depend on the compiler or packer used to compile or pack the binary, the following are the most commonly seen sections in a PE file.

- .**text:** This Section generally contains the CPU instructions executed when the PE file is run. This section is marked as executable.
- **.data:** This Section contains the global variables and other global data used by the PE file.
- **.rsrc:** This Section contains resources that are used by the PE file, for example, images, icons, etc.

We can use the pecheck utility to check the PE header.

```
pecheck redline | grep .text

.text entropy: 6.453919 (Min=0.0, Max=8.0)

pecheck redline | head
.text
.rdata
.data
.ndata


pecheck redline | grep -i dll | grep RegOpenKeyExW
ADVAPI32.dll.RegOpenKeyExW Hint[493]

pe-tree redline   (The pe-tree tool might take some time to initiate.)

```

## basic dynamic analysis

 One quick and dirty way to find more clues about a malware's behavior is by performing basic dynamic analysis. Many of the properties of a malware sample can be hidden when it's not running.

### Caution!

> Dynamic analysis requires running live malware samples that can be destructive. It is highly recommended that you perform malware analysis in an isolated Virtual Machine. You can create a clean snapshot of your Virtual Machine before performing any malware analysis and revert it to start from a clean state again after every analysis. Don't perform malware analysis on a live machine not purpose-built for malware analysis.

In malware analysis, a sandbox is an isolated environment mimicking the actual target environment of a malware, where an analyst runs a sample to learn more about it. Malware analysis sandboxes heavily rely on Virtual Machines, their ability to take snapshots and revert to a clean state when required.

For malware analysis using sandboxes, the following considerations make the malware analysis effective:
- Virtual Machine mimicking the actual target environment of the malware sample
- Ability to take snapshots and revert to clean state
- OS monitoring software, for example, Procmon, ProcExplorer or Regshot, etc.
- Network monitoring software, for example, Wireshark, tcpdump, etc.
- Control over the network through a dummy DNS server and webserver.
- A mechanism to move analysis logs and malware samples in and out of the Virtual Machine without compromising the host (Be careful with this one. If you have a shared directory with your malware analysis VM that remains accessible when running malware, you might risk malware affecting all files in your shared directory)

open source sandboxes :
- https://github.com/kevoreilly/CAPEv2
- (online) https://any.run/
- (online) https://analyze.intezer.com
- (online) https://hybrid-analysis.com/
-  better approach is to search for the sample's hash on the service you are using to see if someone has already submitted it.


```
https://hybrid-analysis.com/ > Report Search > md5sum hash 

ca2dc5a3f94c4f19334cc8b68f256259
Windows 7 64bit > Hybrid Analysis 

which is the first process launched when the sample is launched?
setup_installer.exe

What are the names of the two utilities? (Format: util1.exe and util2.exe)
cmd.exe and powershell.exe

```


## anti-analysis techniques 

### packing and obfuscation 

- A packer obfuscates, compresses, or encrypts the contents of malware
- makes it difficult to analyze malware statically , does not show info for `strings` command

```
strings zmsuz3pinwl
pecheck 


PE check for 'zmsuz3pinwl':
Entropy: 7.978052 (Min=0.0, Max=8.0)
MD5     hash: 1ebb1e268a462d56a389e8e1d06b4945
SHA-1   hash: 1ecc0b9f380896373e81ed166c34a89bded873b5
SHA-256 hash: 98c6cf0b129438ec62a628e8431e790b114ba0d82b76e625885ceedef286d6f5
SHA-512 hash: 6921532b4b5ed9514660eb408dfa5d28998f52aa206013546f9eb66e26861565f852ec7f04c85ae9be89e7721c4f1a5c31d2fae49b0e7fdfd20451191146614a
 entropy: 7.999788 (Min=0.0, Max=8.0)
 entropy: 7.961048 (Min=0.0, Max=8.0)
 entropy: 7.554513 (Min=0.0, Max=8.0)
.rsrc entropy: 6.938747 (Min=0.0, Max=8.0)

```

notice that there is no .text section in the sample, and other sections have execute permissions, which shows that these sections contain executable instructions or will be populated with executable instructions during execution. We will also see that this sample does not have many imports that might show us its functionality, as we saw with the previous sample.


### sandbox evasion 

Some of these techniques are as follows:
- **Long sleep calls:** Malware authors know that sandboxes run for a limited time. Therefore, they program the malware not to perform any activity for a long time after execution. This is often accomplished through long sleep calls. The purpose of this technique is to time out the sandbox.
- **User activity detection:** Some malware samples will wait for user activity before performing malicious activity. The premise of this technique is that there will be no user in a sandbox. Therefore there will be no mouse movement or typing on the keyboard. Advanced malware also detects patterns in mouse movements that are often used in automated sandboxes. This technique is designed to bypass automated sandbox detection.
- **Footprinting user activity:** Some malware checks for user files or activity, like if there are any files in the MS Office history or internet browsing history. If no or little activity is found, the malware will consider the machine as a sandbox and quit. 
- **Detecting VMs:** Sandboxes run on virtual machines. Virtual machines leave artifacts that can be identified by malware. For example, some drivers installed in VMs being run on VMWare or Virtualbox give away the fact that the machine is a VM. Malware authors often associate VMs with sandboxes and would terminate the malware if a VM is detected.


























































